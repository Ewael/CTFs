#!/usr/bin/env python3

from gdbpython import *

init('./malware')

os.system('lsof -ti TCP:4000 | xargs kill') # close port
os.system('rm -f keys/A_A.priv') # key must not exist
run(args=['--serveur'])
setFork('child')

#tbc(0x40327c) # call get_key
#exc('set {int}$rcx=0x0041')
#exc('set {int}$rdx=0x0041')
#tbc(0x402d2b) # call concat '/keys' and keyname
#exc('set $rdi=$rdi+1') # skip '/'
#setFork('parent')
#tbc(0x402db9) # access
#tbc(0x402e45) # cmd1
#tbc(0x4032b3) # send

#tbc(0x403367) # recv 0x400
#tbc(0x40338f) # call send_key
#tbc(0x403146) # call regexc
#hba(0x403146)
#hba(0x40315e) # size check
hba(0x4032d6) # ret before rop
cont()

#hba(0x4020d0) # puts plt
#hba(0x402678) # call puts
#hba(0x402682) # new client
#hba(0x403327) # call fwrite
hba(0x402060) # print plt

print(context())

'''
key name = keys/A_A.priv

openssl genrsa -aes256 -out [priv] -passout [pass] 4096
openssl rsa -in [priv] -passin [pass] -pubout -out [pub]
'''
