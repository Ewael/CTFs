#!/usr/bin/env python3

from gdbpython import *
from Crypto.Util.number import bytes_to_long

h = b'0fdb0eea57198b3bb69e8267690ede5d5ba95ab791638a610372120b773d4acc'
H = []
for i in range(0, len(h), 8):
    H.append(hex(bytes_to_long(h[i:i+8][::-1])))

d = b'2021-03-15|21:34:41\x00'
D = []
for i in range(0, len(d), 8):
    D.append(hex(bytes_to_long(d[i:i+8][::-1])))

keys = []

for n in range(400, 1000):
    os.system('lsof -ti TCP:4000 | xargs kill') # close port
    init('./malware')
    run(args=['--serveur'])
    setFork('child')

    tbc(0x40325e) # call build_pwd
    # hash = 0fdb0eea57198b3bb69e8267690ede5d5ba95ab791638a610372120b773d4acc
    # date = 2021-03-15|21:34:41
    # random_n = ???

    for i in range(len(H)):
        exc(f'set {{long}}($rdi+{i*8})={H[i]}')
    for i in range(len(D)):
        exc(f'set {{long}}($rsi+{i*8})={D[i]}')
    exc(f'set $rdx={hex(n)}')

    ba(0x403263) # after build_pwd
    #ba(0x40327c) # call get_key(password, hash, date)
    #ba(0x402e45) # call cmd1
    setFork('parent')

    cont()
    rax = exc('x/s $rax')[exc('x/s $rax').find('"')+1:-2]
    keys.append(rax)
    print(f'n = {n} -> key = {rax}')
    os.system(f'openssl rsa -in key.priv -out private_key_{n}.txt -passin pass:"{rax}"')

for key in keys:
    print(key)

'''
calling convention = rdi, rsi, rdx, rcx / r10, r8, r9
0fdb0eea57198b3bb69e8267690ede5d5ba95ab791638a610372120b773d4acc_2021-03-15|21:34:41.priv
cmd1 = `openssl genrsa -aes256 -out [priv] -passout [pass] 4096`
cmd2 = `openssl rsa -in [priv] -passin [pass] -pubout -out [pub]`

example:
9afbb9e2c87543a961f9a8f634af6bdf7339cc3d0955444189d1d5d4761a6a08
2021-04-27|17:50:40
0x10c
password =
)4|V>1SY} m,Nz%cl5&=49afbb9e2c87543a961f9a8f634af6bdf7339cc3d0955444189d1d5d4761a6a082021-04-27|17:50:402684.65718621

openssl rsa -in test.priv -out testdec.priv -passin 'pass:)4|V>1SY} m,Nz%cl5&=49afbb9e2c87543a961f9a8f634af6bdf7339cc3d0955444189d1d5d4761a6a082021-04-27|17:50:402684.65718621'

openssl rsautl -decrypt -in flag.txt -out plain.txt -inkey private_key_578.txt -oaep
'''

# 𝔽ℂ𝕊ℂ{𝕔𝕕𝟟𝟜𝕓𝟘𝕕𝟛𝟛𝟜𝕒𝟠𝕓𝕖𝟝𝟞𝟞𝟞𝟜𝟘𝟚𝕔𝕔𝟜𝟠𝟞𝕖𝟠𝕒𝟞𝟚𝟚𝟚𝕕𝕕𝟛𝟚𝟘𝟠𝟜𝕗𝕒𝟛𝟝𝟠𝟝𝕒𝕖𝕔𝟙𝕕𝟜𝟠𝟝𝕗𝟝𝟛𝕖𝟝𝟘𝟠𝕖𝕕𝟜}
# FCSC{cd74b0d334a8be5666402cc486e8a6222dd32084fa3585aec1d485f53e508ed4}
